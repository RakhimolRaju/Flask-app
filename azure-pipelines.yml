trigger:
- main

pool:
  name: UbuntuLocalPool

steps:
# Step 1 - Checkout source code
- checkout: self
  displayName: 'Checkout source code from GitHub'

# Step 2 - Install dependencies
- script: |
    sudo apt update
    sudo apt install -y python3 python3-pip docker.io
    python3 -m pip install --upgrade pip
    pip install flask
  displayName: 'Install Python, pip, Flask, and Docker'

# Step 3 - Build Docker image
- script: |
    cd $(Build.SourcesDirectory)
    ls -la
    docker build -t flaskapp:latest .
  displayName: 'Build Docker Image'

# Step 4 - Run container locally (for verification)
- script: |
    docker stop flaskapp || true
    docker rm flaskapp || true
    docker run -d -p 5000:5000 --name flaskapp flaskapp:latest
    sleep 5
    curl -I http://127.0.0.1:5000 || true
  displayName: 'Run and Test Docker Container'

# Step 5 â€“ Deploy (auto-restart container)
- script: |
    echo "Deploying new container..."
    docker stop flaskapp || true
    docker rm flaskapp || true
    docker run -d -p 5000:5000 --name flaskapp flaskapp:latest
    docker image prune -f
  displayName: 'Auto-Deploy Container on EC2'
